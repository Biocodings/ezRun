---
title: "`r paste('Two groups analysis:', param$comparison)`"
author: "Functional Genomics Center Zurich"
output: 
  html_document:
    self_contained: false
    includes:
      in_header: fgcz_header.html
    css: fgcz.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## This report requires objects: se, param, output, deResult
require(knitr)
require(kableExtra)
require(SummarizedExperiment)
require(webshot)
require(htmlwidgets)
```
Started on `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`

## TwoGroupsAnalysis_Result {.tabset}

### Settings

```{r setting, echo=FALSE}
kable(makeCountResultSummary(param, se), row.names=TRUE, format="html") %>%
  kable_styling(bootstrap_options = "striped", full_width = F,
                position = "left")
```

### Input Dataset
```{r input, echo=FALSE}
dataset <- data.frame(colData(se), check.names=FALSE, stringsAsFactors=FALSE)
ezInteractiveTableRmd(values=dataset, digits=4)
```

### Result Summary
```{r summary, echo=FALSE}
settings = character()
settings["Number of features:"] = nrow(se)
if (!is.null(rowData(se)$isPresentProbe)){
  settings["Number of features with counts above threshold:"] = 
    sum(rowData(se)$isPresentProbe)
}
knitr::kable(as.data.frame(settings), format="html", 
             col.names="Number", row.names=TRUE) %>%
    kable_styling(bootstrap_options = "striped", full_width = F,
                  position = "left")
```

#### Number of significants by p-value and fold-change
```{r gene table, echo=FALSE}
knitr::kable(makeSignificantCounts(se), row.names=TRUE,  format="html") %>%
  kable_styling(bootstrap_options = "striped", full_width = F, 
                position = "left")
```

Full result table for opening with a spreadsheet program 
(e.g. Excel: when opening with Excel, make sure that the Gene symbols are loaded into a column formatted as 'text' that prevents conversion of the symbols to dates).

```{r result live report, echo=FALSE}
resultFile <- makeResultFile(param, se)

ezWrite.table(colData(se)[, "sf", drop=FALSE],
              file="scalingfactors.txt", head="Name", digits=4)

liveReportLink = output$getColumn("Live Report")
deResult$saveToFile(basename(output$getColumn("Live Report")))
```

[`r resultFile$resultZip`](`r resultFile$resultZip`)

[Live Report and Visualizations](`r liveReportLink`)

### Inspection of significant genes

#### Between-group Comparison
[Interactive table of significant genes](`r resultFile$resultHtml`)

```{r make scatter data, echo=FALSE}
scatterData <- makeTestScatterData(param, se)
groupMeans <- scatterData$groupMeans
types <- scatterData$types
isTwoGroup <- ncol(groupMeans) == 2 & !is.null(param$sampleGroup) & 
  !is.null(param$refGroup)
```

```{r scatter comparison, echo=FALSE}
if (isTRUE(isTwoGroup)){
  ## scatter plot
  sampleValues = 2^groupMeans[ , param$sampleGroup]
  refValues = 2^groupMeans[ , param$refGroup]
  p_scatter <- ezXYScatterPlotly(xVec=refValues, yVec=sampleValues,
                                 isPresent=rowData(se)$usedInTest, 
                                 types=types, names=rowData(se)$gene_name,
                                 xlab=param$refGroup, ylab=param$sampleGroup,
                                 main="Comparison of average expression")
  scatterPng <- paste0(param$comparison, "-scatter.png")
  export(p_scatter, file=scatterPng)
  scatterPdf <- sub("png$", "pdf", scatterPng)
  export(p_scatter, file=scatterPdf)
  scatterHtml <- paste0(param$comparison, "-scatter.html")
  saveWidget(as_widget(p_scatter), scatterHtml)
  ### To make legend more visible on non-retinal display
  include_graphics(scatterPng, dpi=72*1.5)
  }
```

```{r scatter comparison link, echo=FALSE, results='asis'}
if (isTRUE(isTwoGroup)){
  cat(paste0("[Plot in pdf](", scatterPdf, ")"), "\n")
  cat("\n")
  cat(paste0("[Interactive comparison plot (With thousands of genes, it can be slow and requires a modern web brwoser for best javascript performance!)](", scatterHtml, ")"), "\n")
}
```

```{r volcano p-value, echo=FALSE}
if (isTRUE(isTwoGroup)){
    ## volcano plot with p-value
    p_volcano <- ezVolcanoPlotly(log2Ratio=rowData(se)$log2Ratio, 
                                 pValue=rowData(se)$pValue, yType="p-value",
                                 isPresent=rowData(se)$usedInTest, types=types,
                                 names=rowData(se)$gene_name,
                                 main=param$comparison)
    volcanoPng <- paste0(param$comparison, "-volcano.png")
    export(p_volcano, file=volcanoPng)
    volcanoPdf <- sub("png$", "pdf", volcanoPng)
    export(p_volcano, file=volcanoPdf)
    volcanoHtml <- paste0(param$comparison, "-volcano.html")
    saveWidget(as_widget(p_volcano), volcanoHtml)
    ### To make legend more visible on non-retinal display
    include_graphics(volcanoPng, dpi=72*1.5)
}
```

```{r volcano p-value link , echo=FALSE, results='asis'}
if (isTRUE(isTwoGroup)){
  cat(paste0("[Plot in pdf](", volcanoPdf, ")"), "\n")
  cat("\n")
  cat(paste0("[Interactive comparison plot (With thousands of genes, it can be slow and requires a modern web brwoser for best javascript performance!)](", volcanoHtml, ")"), "\n")
}
```

```{r scatter all pairs, echo=FALSE, fig.width=min(max(7, 7+(ncol(groupMeans)-2)*3), 30), fig.height=min(max(7, 7+(ncol(groupMeans)-2)*3), 30)}
## All pairs
if (!isTRUE(isTwoGroup)){
  pdfName = paste0(param$comparison, "-scatter.pdf")
  pdf(file=pdfName, width=7, height=7)
  ezAllPairScatter(x=2^groupMeans, isPresent=rowData(se)$usedInTest, types=types)
  dev.off()
  
  ezAllPairScatter(x=2^groupMeans, isPresent=rowData(se)$usedInTest, types=types)
}
```

### Inspection of significant genes (Advanced plots)
```{r volcano FDR, echo=FALSE, warning=FALSE}
if(isTRUE(isTwoGroup)){
  ## warning=FALSE because FDR contains NA. Shall we make them always 1?
  ## volcano plot with FDR
  p_volcano <- ezVolcanoPlotly(log2Ratio=rowData(se)$log2Ratio, 
                               pValue=rowData(se)$fdr, yType="FDR",
                               isPresent=rowData(se)$usedInTest, types=types,
                               names=rowData(se)$gene_name,
                               main=param$comparison)
  volcanoFDRPng <- paste0(param$comparison, "-FDR-volcano.png")
  export(p_volcano, file=volcanoFDRPng)
  volcanoFDRPdf <- sub("png$", "pdf", volcanoFDRPng)
  export(p_volcano, file=volcanoFDRPdf)
  volcanoFDRHtml <- paste0(param$comparison, "-FDR-volcano.html")
  saveWidget(as_widget(p_volcano), volcanoFDRHtml)
  ## To make legend more visible on non-retinal display
  include_graphics(volcanoFDRPng, dpi=72*1.5)
}
```

```{r volcano FDR link, echo=FALSE, results='asis'}
if(isTRUE(isTwoGroup)){
  cat(paste0("[Plot in pdf](", volcanoFDRPdf, ")"), "\n")
  cat("\n")
  cat(paste0("[Interactive comparison plot (With thousands of genes, it can be slow and requires a modern web brwoser for best javascript performance!)](", volcanoFDRHtml, ")"), "\n")
}
```

```{r pvalue hist, echo=FALSE}
myBreaks = seq(0, 1, by=0.002)
histUsed = hist(rowData(se)$pValue[rowData(se)$usedInTest], breaks=myBreaks, plot=FALSE)
histAbs = hist(rowData(se)$pValue[!rowData(se)$usedInTest], breaks=myBreaks, plot=FALSE)
xx = rbind(used=histUsed$counts, absent=histAbs$counts)
xx = shrinkToRange(xx, c(0, max(xx["used", ])))
barplot(xx, space=0, border=NA, col=c("blue", "darkorange"), 
        xlab="p-value", ylab="counts", ylim=c(0, max(xx["used", ])),
        main="p-value histogram")
abline(h=sum(rowData(se)$usedInTest)/ncol(xx))
at = c(0.01, 0.1, 0.25, 0.5, 0.75, 1)
axis(1, at=at*ncol(xx), labels = at)
legend("top", c("used", "not expressed"), col=c("blue", "darkorange"), pch=20, cex=1)
```


